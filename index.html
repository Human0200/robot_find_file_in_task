<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>üìã –ó–∞–ø–∏—Å—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∑–∞–¥–∞—á–∏ - –†–æ–±–æ—Ç –¥–ª—è Bitrix24</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            flex-wrap: wrap;
        }
        
        .button-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 500;
        }
        
        .button-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .support-button {
            background: linear-gradient(135deg, #fd746c 0%, #ff9068 100%);
        }
        
        .install-button {
            background: linear-gradient(135deg, #00b09b 0%, #96c93d 100%);
        }
        
        .delete-button {
            background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
        }
        
        .robots-container {
            padding: 30px;
        }
        
        .robot-group {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid #e9ecef;
        }
        
        .robot-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .robot-header h3 {
            font-size: 1.5em;
            color: #2c3e50;
        }
        
        .robot-status {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
        }
        
        .robot-status.installed {
            background: #d4edda;
            color: #155724;
        }
        
        .robot-status.not-installed {
            background: #f8d7da;
            color: #721c24;
        }
        
        .robot-status.error {
            background: #fff3cd;
            color: #856404;
        }
        
        .robot-description {
            margin-bottom: 20px;
            line-height: 1.6;
        }
        
        .robot-params {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
        }
        
        .robot-params strong {
            display: block;
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .robot-params ul, .robot-params ol {
            margin-left: 20px;
            margin-bottom: 15px;
        }
        
        .robot-params li {
            margin-bottom: 5px;
        }
        
        .robot-params code {
            background: #f1f3f4;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        
        .robot-actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        footer {
            background: #2c3e50;
            padding: 20px;
            text-align: center;
        }
        
        #image-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        #image-container img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s ease;
        }
        
        #image-container img:hover {
            transform: scale(1.1);
        }
        
        .bx24-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 20px;
            margin: 20px;
            text-align: center;
            color: #856404;
        }
        
        .bx24-warning h3 {
            margin-bottom: 10px;
            color: #856404;
        }
        
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }
            
            header {
                padding: 20px;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .robot-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .robot-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìã –ó–∞–ø–∏—Å—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∑–∞–¥–∞—á–∏</h1>
            <p class="subtitle">–ö–æ–ø–∏—Ä—É–µ—Ç —Ñ–∞–π–ª—ã –∏ —Ç–µ–∫—Å—Ç –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∑–∞–¥–∞—á–∏ –≤ CRM-—Å—É—â–Ω–æ—Å—Ç—å –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å</p>
        </header>

        <div id="bx24-warning" class="bx24-warning" style="display: none;">
            <h3>‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ</h3>
            <p>–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è –≤–Ω—É—Ç—Ä–∏ Bitrix24. –û—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç–æ—Ç URL —á–µ—Ä–µ–∑ —É—Å—Ç–∞–Ω–æ–≤–∫—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤ –≤–∞—à–µ–º –ø–æ—Ä—Ç–∞–ª–µ Bitrix24.</p>
        </div>

        <div id="app-content">
            <div class="controls">
                <button id="ListRobots" class="button-link">
                    ü§ñ
                    –ü–æ–∫–∞–∑–∞—Ç—å —Ä–æ–±–æ—Ç–∞
                </button>
                <a href="https://lead-space.ru/#b4494" target="_blank" class="button-link support-button">
                    üí¨
                    –ü–æ–¥–¥–µ—Ä–∂–∫–∞
                </a>
            </div>

            <div class="robots-container">
                <!-- –†–æ–±–æ—Ç –∑–∞–ø–∏—Å–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∑–∞–¥–∞—á–∏ -->
                <div class="robot-group">
                    <div class="robot-header">
                        <h3>üìã –ó–∞–ø–∏—Å—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∑–∞–¥–∞—á–∏</h3>
                        <div class="robot-status" id="status-task">–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ</div>
                    </div>
                    <p class="robot-description">
                        <strong>–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:</strong> –ü–æ–ª—É—á–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ (—Ñ–∞–π–ª—ã –∏ —Ç–µ–∫—Å—Ç), –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –ø—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –ø–æ–ª–µ CRM-—Å—É—â–Ω–æ—Å—Ç–∏ (–ª–∏–¥, –∫–æ–Ω—Ç–∞–∫—Ç, —Å–¥–µ–ª–∫–∞, –∫–æ–º–ø–∞–Ω–∏—è, —Å–º–∞—Ä—Ç-–ø—Ä–æ—Ü–µ—Å—Å) –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏.
                    </p>
                    <div class="robot-params">
                        <strong>–í—Ö–æ–¥–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:</strong>
                        <ul>
                            <li><code>task_id</code> ‚Äî ID –∑–∞–¥–∞—á–∏</li>
                            <li><code>entity_type</code> ‚Äî –¢–∏–ø —Å—É—â–Ω–æ—Å—Ç–∏: <code>lead</code>, <code>contact</code>, <code>company</code>, <code>deal</code>, <code>smart_process</code></li>
                            <li><code>entity_id</code> ‚Äî ID —ç–ª–µ–º–µ–Ω—Ç–∞ (–ª–∏–¥–∞, —Å–¥–µ–ª–∫–∏ –∏ —Ç.–¥.)</li>
                            <li><code>field_code</code> ‚Äî –ö–æ–¥ –ø–æ–ª—è, –≤ –∫–æ—Ç–æ—Ä–æ–µ –Ω—É–∂–Ω–æ –∑–∞–ø–∏—Å–∞—Ç—å —Ñ–∞–π–ª—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, <code>UF_CRM_123456789</code>)</li>
                            <li><code>smart_process_id</code> ‚Äî ID —Ç–∏–ø–∞ —Å–º–∞—Ä—Ç-–ø—Ä–æ—Ü–µ—Å—Å–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–∏ <code>entity_type = smart_process</code>)</li>
                        </ul>

                        <strong>–ß—Ç–æ –¥–µ–ª–∞–µ—Ç —Ä–æ–±–æ—Ç:</strong>
                        <ol>
                            <li>–ü–æ–ª—É—á–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ—Ç—á—ë—Ç–∞ –ø–æ –∑–∞–¥–∞—á–µ</li>
                            <li>–ò–∑–≤–ª–µ–∫–∞–µ—Ç –ø—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã (–≤–∫–ª—é—á–∞—è —Ä–µ–∞–ª—å–Ω—ã–µ <code>FILE_ID</code> —á–µ—Ä–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π)</li>
                            <li>–ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç ID —Ñ–∞–π–ª–æ–≤ –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –ø–æ–ª–µ CRM-—Å—É—â–Ω–æ—Å—Ç–∏</li>
                            <li>–°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–¥–∞—á–∏</li>
                            <li>–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å —á–µ—Ä–µ–∑ <code>return_values</code></li>
                        </ol>

                        <strong>–í–æ–∑–≤—Ä–∞—â–∞–µ–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è:</strong>
                        <ul>
                            <li><code>success</code> ‚Äî –£—Å–ø–µ—à–Ω–æ –ª–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ</li>
                            <li><code>files_count</code> ‚Äî –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤</li>
                            <li><code>files_ids</code> ‚Äî –°—Ç—Ä–æ–∫–∞ —Å ID —Ñ–∞–π–ª–æ–≤ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é</li>
                            <li><code>text_result</code> ‚Äî –¢–µ–∫—Å—Ç –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∑–∞–¥–∞—á–∏</li>
                            <li><code>message</code> ‚Äî –°–æ–æ–±—â–µ–Ω–∏–µ –æ —Å—Ç–∞—Ç—É—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</li>
                        </ul>
                    </div>
                    <div class="robot-actions">
                        <button id="createTaskResultButton" class="button-link install-button">
                            ‚ûï
                            –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
                        </button>
                        <button id="deleteTaskResultButton" class="button-link delete-button">
                            ‚ùå
                            –£–¥–∞–ª–∏—Ç—å
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <footer>
            <div id="image-container">
                <a href="https://lead-space.ru/" target="_blank">
                    <img src="https://lead-space.ru/local/templates/main/upload/logo.svg" alt="Logo">
                </a>
            </div>
        </footer>
    </div>
    <script src="https://api.bitrix24.com/api/v1/"></script>
    <!-- Scripts -->
    <script>
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—â–µ–Ω–æ –ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤–Ω—É—Ç—Ä–∏ Bitrix24
        function isInBitrix24() {
            return typeof BX24 !== 'undefined' && 
                   window.parent !== window && 
                   window.location !== window.parent.location;
        }

        // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º BX24 API —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –º—ã –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ Bitrix24
        function loadBX24API() {
            return new Promise((resolve, reject) => {
                if (isInBitrix24()) {
                    const script = document.createElement('script');
                    script.src = '//api.bitrix24.com/api/v1/';
                    script.onload = resolve;
                    script.onerror = reject;
                    document.head.appendChild(script);
                } else {
                    resolve(); // –ù–µ –≤ Bitrix24, –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
                }
            });
        }

        // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        async function initApp() {
            try {
                await loadBX24API();
                
                if (!isInBitrix24()) {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –∏ —Å–∫—Ä—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
                    document.getElementById('bx24-warning').style.display = 'block';
                    document.getElementById('app-content').style.display = 'none';
                    return;
                }

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
                initMainApp();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:', error);
            }
        }

        // –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        function initMainApp() {
            const robot = {
                code: 'robot_task_result_to_entity',
                name: '–ó–∞–ø–∏—Å–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–¥–∞—á–∏ –≤ —Å—É—â–Ω–æ—Å—Ç—å (LeadSpace)',
                handler: 'https://crm.verbconsult.ru/custom-robot/TaskResultToEntity.php',
                statusElementId: 'status-task'
            };

            const statusEl = document.getElementById(robot.statusElementId);
            const createBtn = document.getElementById('createTaskResultButton');
            const deleteBtn = document.getElementById('deleteTaskResultButton');
            const listBtn = document.getElementById('ListRobots');

            // === –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ REST API ===
            async function checkApiAvailability() {
                try {
                    const result = await callMethod('methods', {});
                    const methods = result.data();
                    const hasBizProc = Object.keys(methods).some(method => method.startsWith('bizproc'));
                    
                    if (!hasBizProc) {
                        throw new Error('–ú–æ–¥—É–ª—å –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ –≤–∞—à–µ–º –ø–æ—Ä—Ç–∞–ª–µ');
                    }
                    return true;
                } catch (error) {
                    console.error('API –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ:', error);
                    showNotify('‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ REST API: ' + error.message, 'error');
                    return false;
                }
            }

            // === –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ ===
            async function checkPermissions() {
                try {
                    const result = await callMethod('profile', {});
                    const user = result.data();
                    
                    if (!user.ADMIN) {
                        throw new Error('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤. –¢—Ä–µ–±—É—é—Ç—Å—è –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞');
                    }
                    return true;
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞:', error);
                    showNotify('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞: ' + error.message, 'error');
                    return false;
                }
            }

            // === –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Ä–æ–±–æ—Ç–∞ ===
            async function checkStatus() {
                try {
                    const apiAvailable = await checkApiAvailability();
                    if (!apiAvailable) return;

                    const hasPermissions = await checkPermissions();
                    if (!hasPermissions) return;

                    const result = await callMethod('bizproc.robot.list', {});
                    const installed = result.data().includes(robot.code);
                    updateStatus(installed);
                } catch (err) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞:', err);
                    if (statusEl) {
                        statusEl.textContent = '–û—à–∏–±–∫–∞';
                        statusEl.className = 'robot-status error';
                    }
                    showNotify('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞: ' + err.message, 'error');
                }
            }

            // === –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–æ–±–æ—Ç–∞ ===
            createBtn?.addEventListener('click', async () => {
                try {
                    const apiAvailable = await checkApiAvailability();
                    if (!apiAvailable) return;

                    const hasPermissions = await checkPermissions();
                    if (!hasPermissions) return;

                    const params = {
                        CODE: robot.code,
                        HANDLER: robot.handler.trim(),
                        AUTH_USER_ID: 1,
                        NAME: robot.name,
                        PROPERTIES: {
                            task_id: { Name: 'ID –∑–∞–¥–∞—á–∏', Type: 'int', Required: 'Y' },
                            entity_type: { 
                                Name: '–¢–∏–ø —Å—É—â–Ω–æ—Å—Ç–∏', 
                                Type: 'select', 
                                Required: 'Y', 
                                Options: { lead: '–õ–∏–¥', contact: '–ö–æ–Ω—Ç–∞–∫—Ç', company: '–ö–æ–º–ø–∞–Ω–∏—è', deal: '–°–¥–µ–ª–∫–∞', smart_process: '–°–º–∞—Ä—Ç-–ø—Ä–æ—Ü–µ—Å—Å' }
                            },
                            entity_id: { Name: 'ID —Å—É—â–Ω–æ—Å—Ç–∏', Type: 'int', Required: 'Y' },
                            field_code: { Name: '–ö–æ–¥ –ø–æ–ª—è –¥–ª—è —Ñ–∞–π–ª–æ–≤', Type: 'string', Required: 'Y' },
                            smart_process_id: { Name: 'ID —Å–º–∞—Ä—Ç-–ø—Ä–æ—Ü–µ—Å—Å–∞', Type: 'int', Required: 'N' }
                        },
                        RETURN_PROPERTIES: {
                            success: { Name: '–£—Å–ø–µ—à–Ω–æ', Type: 'bool' },
                            files_count: { Name: '–ö–æ–ª-–≤–æ —Ñ–∞–π–ª–æ–≤', Type: 'int' },
                            files_ids: { Name: 'ID —Ñ–∞–π–ª–æ–≤', Type: 'string' },
                            text_result: { Name: '–¢–µ–∫—Å—Ç', Type: 'string' },
                            message: { Name: '–°–æ–æ–±—â–µ–Ω–∏–µ', Type: 'string' }
                        }
                    };

                    await callMethod('bizproc.robot.add', params);
                    showNotify('‚úÖ –†–æ–±–æ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
                    updateStatus(true);
                } catch (err) {
                    showNotify('‚ùå –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏: ' + (err.message || err), 'error');
                }
            });

            // === –£–¥–∞–ª–∏—Ç—å —Ä–æ–±–æ—Ç–∞ ===
            deleteBtn?.addEventListener('click', async () => {
                if (!confirm('–£–¥–∞–ª–∏—Ç—å —Ä–æ–±–æ—Ç–∞?')) return;

                try {
                    const apiAvailable = await checkApiAvailability();
                    if (!apiAvailable) return;

                    const hasPermissions = await checkPermissions();
                    if (!hasPermissions) return;

                    await callMethod('bizproc.robot.delete', { CODE: robot.code });
                    showNotify('‚úÖ –†–æ–±–æ—Ç —É–¥–∞–ª—ë–Ω');
                    updateStatus(false);
                } catch (err) {
                    showNotify('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + (err.message || err), 'error');
                }
            });

            // === –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ —Ä–æ–±–æ—Ç–æ–≤ ===
            listBtn?.addEventListener('click', async () => {
                try {
                    const apiAvailable = await checkApiAvailability();
                    if (!apiAvailable) return;

                    const hasPermissions = await checkPermissions();
                    if (!hasPermissions) return;

                    const result = await callMethod('bizproc.robot.list', {});
                    const list = result.data();
                    showNotify(list.length ? '–†–æ–±–æ—Ç—ã:\n' + list.join('\n') : '–ù–µ—Ç —Ä–æ–±–æ—Ç–æ–≤');
                } catch (err) {
                    showNotify('‚ùå –û—à–∏–±–∫–∞: ' + (err.message || err), 'error');
                }
            });

            // === –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ===
            function callMethod(method, params) {
                return new Promise((resolve, reject) => {
                    BX24.callMethod(method, params, (result) => {
                        if (result.error()) {
                            const error = result.error();
                            console.error('REST Error:', error);
                            
                            if (error.includes('404') || error.includes('not found')) {
                                reject(new Error('–ú–µ—Ç–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω. –í–æ–∑–º–æ–∂–Ω–æ, –º–æ–¥—É–ª—å –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'));
                            } else if (error.includes('access denied') || error.includes('permission')) {
                                reject(new Error('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞'));
                            } else {
                                reject(error);
                            }
                        } else {
                            resolve(result);
                        }
                    });
                });
            }

            function updateStatus(installed) {
                if (statusEl) {
                    statusEl.textContent = installed ? '–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω' : '–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω';
                    statusEl.className = 'robot-status ' + (installed ? 'installed' : 'not-installed');
                }
            }

            function showNotify(message, type = 'success') {
                const notif = document.createElement('div');
                notif.style.cssText = `
                    position: fixed; top: 20px; right: 20px; padding: 12px 16px;
                    background: ${type === 'success' ? '#4CAF50' : '#f44336'};
                    color: white; border-radius: 6px; z-index: 10000;
                    max-width: 300px; word-break: break-word; font-size: 14px;
                `;
                notif.textContent = message;
                document.body.appendChild(notif);
                setTimeout(() => notif.remove(), 5000);
            }

            // === –ü–ª–∞–≤–∞—é—â–∞—è –∏–∫–æ–Ω–∫–∞ ===
            const imgContainer = document.getElementById('image-container');
            if (imgContainer) {
                const updatePos = () => {
                    const h = window.innerHeight, w = window.innerWidth;
                    const st = window.pageYOffset, sl = window.pageXOffset;
                    const eh = imgContainer.offsetHeight, ew = imgContainer.offsetWidth;
                    imgContainer.style.bottom = Math.max(0, h - (st + eh)) + 'px';
                    imgContainer.style.right = Math.max(0, w - (sl + ew)) + 'px';
                };
                window.addEventListener('scroll', updatePos);
                window.addEventListener('resize', updatePos);
                updatePos();
            }

            // === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ===
            checkStatus();
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>